---
title: "Analyzing Family-Level Changes Across Mixing Ratios, Passages and Watertype Treatments (relative abundance)"
author: "Xiu Jia"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
html_document:
number_sections: true
editor_options: 
 chunk_output_type: console
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, include = FALSE}
# Prepare the library and work directory
# clean the work environment
rm(list=ls())

# Libraries
library(tidyverse) 
library(phyloseq)
library(RColorBrewer) # for color pallet
library(lme4) # for leaner mixed model
library(lmerTest)

mytheme_facet <- theme_bw() +
  theme(text = element_text(size = 8),
        plot.title = element_text(face="bold", size = 8),
        legend.position="right",
        legend.background = element_rect(),
        legend.title = element_text(face = "bold"),
        strip.background = element_blank(),
        strip.text = element_text(face = "bold", size = 8),
        axis.ticks = element_line(colour = "grey70", size = 0.2),
        panel.grid.major = element_line(colour = "grey70", size = 0.2),
        panel.grid.minor = element_blank())

```

### Load data (raw reads)  
Here, we combine the OTU table, (simplified) taxonomy table, and the sample metadata (all .csv files) into a phyloseq object as it is easier to work on a integrated dataset
```{r}
# read phyloseq object
ps_rawreads <- readRDS("phyloseq_object_family_microcosm_raw_reads.rds")

# check
ps_rawreads
summary(sample_data(ps_rawreads))
otu_table(t(ps_rawreads))[1:3, 1:3]

# calculate relative abundance 
com_tot_family_rel <- data.frame(otu_table(ps_rawreads)) %>%
  mutate(across(everything(), ~ .x / sum(.x)))

dim(com_tot_family_rel)
com_tot_family_rel[1:3, 1:3]


```
The total relative abundance per sample ranges: `r range(colSums(com_tot_family_rel))`.


### temporal change - scatter plot with linear correlation 
<!-- Temporal Patterns of Microbial Family Abundance in Different Mixing Ratios and Watertype Conditions. -->
```{r, warning=FALSE, message=FALSE}

# using relative abundance data to do correlation

com <- data.frame(t(com_tot_family_rel))

df <- as.data.frame(com) %>% 
  rownames_to_column() %>%  
  separate(rowname, c("fresh_bac", "sea_bac", "watertype", "passage", "replicate"), "_") %>%  
  mutate(watertype = factor(watertype, levels = c("f", "b"), labels = c("Freshwater", "Seawater"))) %>% 
  unite(mix, c(fresh_bac, sea_bac), sep = "_", remove = TRUE) %>% 
  mutate(mix = factor(mix, levels = c("f0_b100", "f25_b75", "f50_b50", "f75_b25", "f100_b0"))) %>% 
  mutate(passage = as.numeric(str_remove(passage, "^p"))) %>% 
  mutate(replicate = factor(replicate))

# Update column names to be syntactically valid
colnames(df) <- make.names(colnames(df), unique = TRUE)

# Step 1: The dataset was filtered to retain only the families that appeared at least three times across the different passages for each replicate within a given mixing ratio and watertype combination.

# Reshape the data from wide to long format
warning("Check if you start from the right column number for the bacterial family names!")
long_df <- df %>%
  pivot_longer(cols = 5:ncol(df),  # Assuming family columns start from the 5th column
               names_to = "family",  # The column name will become 'family'
               values_to = "abundance")  # The values will go into 'abundance'

# filter step
filtered_df <- long_df %>%
  group_by(mix, watertype, replicate, family) %>%
  mutate(nozero_abundance_per_passage = sum(abundance != 0)) %>%
  ungroup() %>%
  group_by(mix, watertype, replicate, family) %>%
  filter(max(nozero_abundance_per_passage) >= 3) %>%
  ungroup() %>% 
  group_by(family) %>%
  filter(max(abundance) >= 0.001) %>%  # Exclude families with max abundance < 0.001
  select(-nozero_abundance_per_passage)

# Use pivot_wider to expand families as columns
df <- filtered_df %>%
  pivot_wider(
    names_from = family,   # Family names will become column names
    values_from = abundance,  # The values to be filled in these new columns
    values_fill = list(abundance = 0)  # In case there are missing values, fill with NA
  )

# View the expanded data frame
df[1:3, 1:7]

dim(df)

################################################
##### using a loop to write down all the results
################################################

# Define output folder for individual plots
output_folder <- "family_time_series_changing_RA/"
dir.create(output_folder, showWarnings = FALSE)  # Create folder if it doesn't exist

# Define the full paths for the files within the output folder
lmer_results_file <- file.path(output_folder, "family_time_series_changing_lmer_summary_and_anova.txt")
correlation_results_file <- file.path(output_folder, "family_time_series_changing_correlation_results.csv")


# Initialize an empty data frame for Spearman correlation results
correlation_results <- data.frame(Family = character(),
                                  mix = character(),
                                  watertype = character(),
                                  r_value = numeric(),
                                  p_value = numeric(),
                                  stringsAsFactors = FALSE)

# Open a text sink for lmer results
sink(lmer_results_file)

# Loop through all filtered families
family_columns <- colnames(df)[5:ncol(df)]  # Assuming families start from the 5th column
warning("Check if you start from the right column number for the bacterial family names!")

for (family in family_columns) {
  cat("\n==============================\n")
  cat("Analysis for Family:", family, "\n")
  cat("==============================\n")
  
  # Fit the linear mixed model
  formula <- as.formula(paste(family, "~ passage * watertype * mix + (1 | replicate)"))
  model <- lmer(formula, data = df)
  
  # Print model summary
  cat("\nModel Summary:\n")
  print(summary(model))
  
  # Perform ANOVA
  cat("\nANOVA Results:\n")
  anova_results <- anova(model)
  print(anova_results)
  
  # Calculate Spearman correlation for each group (mix and watertype)
  correlation_data <- df %>%
    group_by(mix, watertype) %>%
    summarize(
      r_value = cor(passage, .data[[family]], method = "spearman"),
      p_value = cor.test(passage, .data[[family]], method = "spearman")$p.value,
      .groups = "drop"
    )  %>%
    mutate(Family = family) %>% 
    mutate(mix = factor(mix, levels = c("f0_b100", "f25_b75", "f50_b50", "f75_b25", "f100_b0"))) 
  
  # Append to the results data frame
  correlation_results <- bind_rows(correlation_results, correlation_data)
  
  # Filter out rows with NA in r_value or p_value
  correlation_data <- correlation_data %>% 
    mutate(mix = factor(mix, levels = c("f0_b100", "f25_b75", "f50_b50", "f75_b25", "f100_b0"),  labels = c("fresh:sea\n0:100", "fresh:sea\n25:75", "fresh:sea\n50:50", "fresh:sea\n75:25", "fresh:sea\n100:0")))  %>%
    filter(!is.na(r_value) & !is.na(p_value))
  
  # If no valid correlation data (r_value, p_value), skip plotting
  if (nrow(correlation_data) == 0) {
    next  # Skip the rest of the loop for this family
  }
  
  # Prepare data for plotting
  new_data <- expand.grid(
    passage = unique(df$passage),
    watertype = unique(df$watertype),
    mix = unique(df$mix),
    replicate = unique(df$replicate)  # Exclude random effects in predictions
  )
  new_data$predicted <- predict(model, newdata = new_data, re.form = NA)
  new_data <- new_data %>% 
    mutate(mix = factor(mix, levels = c("f0_b100", "f25_b75", "f50_b50", "f75_b25", "f100_b0"),  labels = c("fresh:sea\n0:100", "fresh:sea\n25:75", "fresh:sea\n50:50", "fresh:sea\n75:25", "fresh:sea\n100:0"))) 
  
  # Create a summary data frame for annotations
  annotation_data <- correlation_data %>%
    filter(p_value <= 0.05) %>%  # Keep only significant p-values
    group_by(watertype, mix) %>%
    summarise(
      r_value = round(mean(r_value), 2),
      p_value = signif(mean(p_value), 2),
      x_position = mean(df$passage),  # Middle of passage range
      y_position = mean(new_data$predicted[new_data$watertype == watertype & new_data$mix == mix]) + 0.2
    ) %>%
    mutate(label = paste0("r = ", r_value, ", p = ", p_value))
  
  df1 <- df %>% 
  mutate(mix = factor(mix, levels = c("f0_b100", "f25_b75", "f50_b50", "f75_b25", "f100_b0"),  labels = c("fresh:sea\n0:100", "fresh:sea\n25:75", "fresh:sea\n50:50", "fresh:sea\n75:25", "fresh:sea\n100:0"))) 
  
  # Create a plot of raw data (dots) and predicted trends (line)
  p <- ggplot(df1, aes(x = passage, y = get(family), color = watertype, shape = replicate)) +
    geom_point(size = 2, alpha = 0.3) +  # Raw data as dots
    geom_line(data = new_data, aes(x = passage, y = predicted, group = interaction(watertype, mix)), size = 0.5, alpha = 0.5) +  # Predicted trends as lines
    facet_grid(~ mix) +
    labs(
      title = paste("Observed and Predicted Values for", family),
      x = "Passage",
      y = "Relative abundance",
      color = "Watertype",
      shape = "Replicate"
    ) +
    scale_color_manual(values = c("#0072B2", "#F8766D")) +
    scale_x_continuous(breaks=c(1, 2, 3, 4, 5, 6)) +
    mytheme_facet +
    # Add annotation for significant terms
    geom_text(
    data = annotation_data,
    aes(
      x = x_position,
      y = y_position,
      label = label,
      color = watertype  # Match annotation color to watertype
    ),
    inherit.aes = FALSE,
    size = 2.5, 
    hjust = 0.5, 
    vjust = 0
  ) +
    theme(legend.position = "none") # or theme(legend.position = "bottom") # with legend 
  
  # Save the plot as an individual jpg
  output_file <- file.path(output_folder, paste0(family, ".jpg")) # _legend
  ggsave(output_file, plot = p, width = 6, height = 2)
}

# Close the text sink
sink()

# Write the correlation results to a CSV file
write.csv(correlation_results, correlation_results_file, row.names = FALSE)

cat("Lmer (linear mixed model) results have been saved to:", lmer_results_file, "\n")
cat("Spearman correlation results have been saved to:", correlation_results_file, "\n")

```


### change over mixing ratios - scatter plot with linear correlation
```{r, warning=FALSE, message=FALSE}

# using relative abundance data to do correlation

com <- data.frame(t(com_tot_family_rel))

df <- as.data.frame(com) %>% 
  rownames_to_column() %>%  
  separate(rowname, c("fresh_bac", "sea_bac", "watertype", "passage", "replicate"), "_") %>%  
  mutate(watertype = factor(watertype, levels = c("f", "b"), labels = c("Freshwater", "Seawater"))) %>% 
  mutate(fresh_bac = as.numeric(str_remove(fresh_bac, "^f"))) %>% 
  mutate(passage = factor(passage)) %>% 
  mutate(replicate = factor(replicate)) %>% 
  select(-sea_bac)

# Update column names to be syntactically valid
colnames(df) <- make.names(colnames(df), unique = TRUE)

df[1:3, 1:7]

# Step 1: The dataset was filtered to retain only the families that appeared at least three times across the different mixing ratios for each replicate within a given passage and watertype combination. As well as remove families with max abundance < 0.001

# Reshape the data from wide to long format
warning("Check if you start from the right column number for the bacterial family names!")
long_df <- df %>%
  pivot_longer(cols = 5:ncol(df),  # Assuming family columns start from the 5th column
               names_to = "family",  # The column name will become 'family'
               values_to = "abundance")  # The values will go into 'abundance'

# filter step
filtered_df <- long_df %>%
  group_by(passage, watertype, replicate, family) %>%
  mutate(nozero_abundance_per_passage = sum(abundance != 0)) %>%
  ungroup() %>%
  group_by(passage, watertype, replicate, family) %>%
  filter(max(nozero_abundance_per_passage) >= 3) %>%
  ungroup() %>% 
  group_by(family) %>%
  filter(max(abundance) >= 0.001) %>%  # Exclude families with max abundance < 0.001
  select(-nozero_abundance_per_passage)

# Use pivot_wider to expand families as columns
df <- filtered_df %>%
  pivot_wider(
    names_from = family,   # Family names will become column names
    values_from = abundance,  # The values to be filled in these new columns
    values_fill = list(abundance = 0)  # In case there are missing values, fill with NA
  )

# View the expanded data frame
df[1:3, 1:7]

dim(df)

################################################
##### using a loop to write down all the results
################################################

# Define output folder for individual plots
output_folder <- "family_mixing_ratio_changing_RA/"
dir.create(output_folder, showWarnings = FALSE)  # Create folder if it doesn't exist

# Define the full paths for the files within the output folder
lmer_results_file <- file.path(output_folder, "family_mixing_ratio_changing_lmer_summary_and_anova.txt")
correlation_results_file <- file.path(output_folder, "family_mixing_ratio_changing_correlation_results.csv")


# Initialize an empty data frame for Spearman correlation results
correlation_results <- data.frame(Family = character(),
                                  watertype = character(),
                                  passage = character(),
                                  r_value = numeric(),
                                  p_value = numeric(),
                                  stringsAsFactors = FALSE)

# Open a text sink for lmer results
sink(lmer_results_file)

# Loop through all filtered families
warning("Check if you start from the right column number for the bacterial family names!")
family_columns <- colnames(df)[5:ncol(df)]  # Assuming families start from the 5th column


for (family in family_columns) {
  cat("\n==============================\n")
  cat("Analysis for Family:", family, "\n")
  cat("==============================\n")
  
  # Fit the linear fresh_baced model
  formula <- as.formula(paste(family, "~ fresh_bac * watertype * passage  + (1 | replicate)"))
  model <- lmer(formula, data = df)
  
  # Print model summary
  cat("\nModel Summary:\n")
  print(summary(model))
  
  # Perform ANOVA
  cat("\nANOVA Results:\n")
  anova_results <- anova(model)
  print(anova_results)
  
  # Calculate Spearman correlation for each group (fresh_bac and watertype). As we only have a fwe passages, Pearson correlation might not be relevant
  correlation_data <- df %>%
    group_by(watertype, passage) %>%
    summarize(
      r_value = cor(fresh_bac, .data[[family]], method = "spearman"),
      p_value = cor.test(fresh_bac, .data[[family]], method = "spearman")$p.value,
      .groups = "drop"
    )  %>%
    mutate(Family = family) 
  
  # Append to the results data frame
  correlation_results <- bind_rows(correlation_results, correlation_data)
  
  # Filter out rows with NA in r_value or p_value
  correlation_data <- correlation_data %>% 
    # mutate(fresh_bac = factor(fresh_bac))  %>%
    filter(!is.na(r_value) & !is.na(p_value))
  
  # If no valid correlation data (r_value, p_value), skip plotting
  if (nrow(correlation_data) == 0) {
    next  # Skip the rest of the loop for this family
  }
  
  # Prepare data for plotting
  new_data <- expand.grid(
    passage = unique(df$passage),
    watertype = unique(df$watertype),
    fresh_bac = unique(df$fresh_bac),
    replicate = unique(df$replicate)  # Exclude random effects in predictions
  )
  new_data$predicted <- predict(model, newdata = new_data, re.form = NA)
  
  # Create a summary data frame for annotations
  annotation_data <- correlation_data %>%
    filter(p_value <= 0.05) %>%  # Keep only significant p-values
    group_by(watertype, passage) %>%
    summarise(
      r_value = round(mean(r_value), 2),
      p_value = signif(mean(p_value), 2),
      x_position = mean(df$fresh_bac),  # Middle of fresh_bac range
      y_position = mean(new_data$predicted[new_data$watertype == watertype & new_data$passage == passage]) + 0.2
    ) %>%
    mutate(label = paste0("r = ", r_value, ", p = ", p_value))
  
  # Create a plot of raw data (dots) and predicted trends (line)
  p <- ggplot(df, aes(x = fresh_bac, y = get(family), color = watertype, shape = replicate)) +
    geom_point(size = 2, alpha = 0.3) +  # Raw data as dots
    geom_line(data = new_data, aes(x = fresh_bac, y = predicted, group = interaction(watertype, passage)), size = 0.5, alpha = 0.5) +  # Predicted trends as lines
    facet_grid(~ passage) +
    labs(
      title = paste("Observed and Predicted Values for", family),
      x = "Freshwater bacteria proportion (%)",
      y = "Relative abundance",
      color = "Watertype",
      shape = "Replicate"
    ) +
    scale_color_manual(values = c("#0072B2", "#F8766D")) +
    scale_x_continuous(breaks=c(0, 25, 50, 75, 100)) +
    mytheme_facet +
    # Add annotation for significant terms
    geom_text(
    data = annotation_data,
    aes(
      x = x_position,
      y = y_position,
      label = label,
      color = watertype  # Match annotation color to watertype
    ),
    inherit.aes = FALSE,
    size = 2.5, 
    hjust = 0.5, 
    vjust = 0
  ) +
    theme(legend.position = "none")
  
  # Save the plot as an individual jpg
  output_file <- file.path(output_folder, paste0(family, ".jpg"))
  ggsave(output_file, plot = p, width = 7, height = 2)
}

# Close the text sink
sink()

# Write the correlation results to a CSV file
write.csv(correlation_results, correlation_results_file, row.names = FALSE)

cat("Lmer (linear fresh_baced model) results have been saved to:", lmer_results_file, "\n")
cat("Spearman correlation results have been saved to:", correlation_results_file, "\n")

```

### Session Info
```{r}
sessionInfo()
```
